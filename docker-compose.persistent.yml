# ==============================================================================
# DeepStream 8.0 + YOLO11x Docker Compose Configuration
# WITH NAMED VOLUMES (Persistent Storage)
# ==============================================================================

services:
  deepstream-app:
    image: deepstream-yolo11:latest
    container_name: deepstream-yolo11-app
    build:
      context: .
      dockerfile: Dockerfile.x86
      args:
        - CUDA_VER=12.2
        - TENSORRT_VER=8.6.1

    # GPU Configuration
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility, video]

    runtime: nvidia
    network_mode: host

    # Environment variables
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - DEEPSTREAM_DIR=/opt/nvidia/deepstream/deepstream-8.0
      - CUDA_VER=12.2
      - GST_DEBUG=${GST_DEBUG:-2}
      - GST_DEBUG_NO_COLOR=1
      - PYTHONUNBUFFERED=1
      - TZ=${TZ:-Europe/Madrid}
      - API_URL=${API_URL:-http://localhost/api}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-all}

    # NAMED VOLUMES (Docker-managed persistent storage)
    volumes:
      # TensorRT engines - NAMED VOLUME (persistent across container recreations)
      - deepstream-engines:/app/engines

      # Logs - NAMED VOLUME
      - deepstream-logs:/app/logs

      # Recordings - NAMED VOLUME
      - deepstream-recordings:/app/recordings

      # Output - NAMED VOLUME
      - deepstream-output:/app/output

      # Configuration - BIND MOUNT (easier to edit from host)
      - ./configs:/app/configs

      # X11 socket - BIND MOUNT (must be from host)
      - /tmp/.X11-unix:/tmp/.X11-unix:rw

      # Optional: Mount source code for development
      # - ./deepstream_api:/app/deepstream_api

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "nvidia-smi"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Security options
    security_opt:
      - seccomp:unconfined
      # Uncomment on RedHat/Rocky/CentOS for X11 display:
      # - label:type:container_runtime_t

    ipc: host

# ==============================================================================
# NAMED VOLUMES DEFINITION
# Docker manages these volumes - data persists across container recreations
# ==============================================================================
volumes:
  # TensorRT engines volume (~400MB per GPU model)
  deepstream-engines:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/volumes/engines

  # Logs volume
  deepstream-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/volumes/logs

  # Recordings volume (could be large)
  deepstream-recordings:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/volumes/recordings

  # Output volume
  deepstream-output:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/volumes/output

# ==============================================================================
# VOLUME MANAGEMENT COMMANDS
# ==============================================================================
# List volumes:
#   docker volume ls
#
# Inspect a volume:
#   docker volume inspect deepstream-engines
#
# Backup a volume:
#   docker run --rm -v deepstream-engines:/data -v $(pwd):/backup \
#     ubuntu tar czf /backup/engines-backup.tar.gz -C /data .
#
# Restore a volume:
#   docker run --rm -v deepstream-engines:/data -v $(pwd):/backup \
#     ubuntu tar xzf /backup/engines-backup.tar.gz -C /data
#
# Remove unused volumes:
#   docker volume prune
#
# Remove specific volume (WARNING: deletes data):
#   docker volume rm deepstream-engines
# ==============================================================================
