# ==============================================================================
# Docker Compose - Sistema de Control de Aforo
# DeepStream 8.0 + PeopleNet
# ==============================================================================
#
# Uso:
#   docker compose -f docker-compose.peoplenet.yml up -d
#   docker compose -f docker-compose.peoplenet.yml logs -f
#   docker compose -f docker-compose.peoplenet.yml down
# ==============================================================================

services:
  aforo:
    build:
      context: .
      dockerfile: Dockerfile.peoplenet
    image: deepstream-peoplenet:latest
    container_name: aforo-peoplenet

    # GPU access
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    # Network: host mode for RTSP access
    network_mode: host

    # Environment
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
      - API_URL=${API_URL:-http://172.80.20.22/api}
      - HEADLESS=true
      - GST_DEBUG=1

    # Volumes
    volumes:
      # Modelo PeopleNet (REQUERIDO)
      - ./models/peoplenet:/app/models/peoplenet
      # Logs persistentes
      - ./logs:/app/logs

    # Restart policy
    restart: unless-stopped

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

# ==============================================================================
# Requisitos previos:
# ==============================================================================
# 1. Descargar modelo PeopleNet:
#    - Descarga desde NGC: nvidia/tao/peoplenet:deployable_quantized_onnx_v2.6.3
#    - Coloca resnet34_peoplenet.onnx en ./models/peoplenet/
#
# 2. Configurar API_URL (opcional):
#    export API_URL=http://tu-servidor/api
#
# 3. Ejecutar:
#    docker compose -f docker-compose.peoplenet.yml up -d
# ==============================================================================
